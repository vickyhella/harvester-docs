"use strict";(self.webpackChunkharvester_docs=self.webpackChunkharvester_docs||[]).push([[1619],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var i=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=i.createContext({}),c=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return i.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},p=i.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=c(n),h=o,m=p["".concat(s,".").concat(h)]||p[h]||d[h]||a;return n?i.createElement(m,r(r({ref:t},u),{},{components:n})):i.createElement(m,r({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,r=new Array(a);r[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var c=2;c<a;c++)r[c]=n[c];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}p.displayName="MDXCreateElement"},5834:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var i=n(7462),o=(n(7294),n(3905));const a={title:"Multiple NICs VM Connectivity",descripion:"How to deal VMs with multiple NICs in Harvester",slug:"multiple-nics-vm-connectivity",authors:[{name:"Date Huang",title:"Software Engineer",url:"https://github.com/tjjh89017",image_url:"https://github.com/tjjh89017.png"}],tags:["vm","network"],hide_table_of_contents:!1},r="Multiple NICs VM Connectivity",l={permalink:"/harvester-docs/zh/kb/multiple-nics-vm-connectivity",editUrl:"https://github.com/vickyhella/harvester-docs/edit/main/kb/2022-03-10/multiple_nics_vm_connectivity.md",source:"@site/kb/2022-03-10/multiple_nics_vm_connectivity.md",title:"Multiple NICs VM Connectivity",description:"What is the default behavior of a VM with multiple NICs",date:"2022-03-10T00:00:00.000Z",formattedDate:"2022\u5e743\u670810\u65e5",tags:[{label:"vm",permalink:"/harvester-docs/zh/kb/tags/vm"},{label:"network",permalink:"/harvester-docs/zh/kb/tags/network"}],readingTime:3.955,hasTruncateMarker:!1,authors:[{name:"Date Huang",title:"Software Engineer",url:"https://github.com/tjjh89017",image_url:"https://github.com/tjjh89017.png",imageURL:"https://github.com/tjjh89017.png"}],frontMatter:{title:"Multiple NICs VM Connectivity",descripion:"How to deal VMs with multiple NICs in Harvester",slug:"multiple-nics-vm-connectivity",authors:[{name:"Date Huang",title:"Software Engineer",url:"https://github.com/tjjh89017",image_url:"https://github.com/tjjh89017.png",imageURL:"https://github.com/tjjh89017.png"}],tags:["vm","network"],hide_table_of_contents:!1},prevItem:{title:"NIC Naming Scheme",permalink:"/harvester-docs/zh/kb/nic-naming-scheme"},nextItem:{title:"VM Scheduling",permalink:"/harvester-docs/zh/kb/vm-scheduling"}},s={authorsImageUrls:[void 0]},c=[{value:"What is the default behavior of a VM with multiple NICs",id:"what-is-the-default-behavior-of-a-vm-with-multiple-nics",level:2},{value:"How-to identify connectivity issues",id:"how-to-identify-connectivity-issues",level:2},{value:"Why do connectivity issues occur randomly",id:"why-do-connectivity-issues-occur-randomly",level:2},{value:"How to avoid the random connectivity issues",id:"how-to-avoid-the-random-connectivity-issues",level:2},{value:"Disable DHCP on secondary NIC",id:"disable-dhcp-on-secondary-nic",level:3},{value:"Cloud-Init config",id:"cloud-init-config",level:4},{value:"Disable secondary NIC default route from DHCP",id:"disable-secondary-nic-default-route-from-dhcp",level:3},{value:"Cloud-Init config",id:"cloud-init-config-1",level:4}],u={toc:c};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,i.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"what-is-the-default-behavior-of-a-vm-with-multiple-nics"},"What is the default behavior of a VM with multiple NICs"),(0,o.kt)("p",null,"In ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/harvester/harvester/issues/1059"},"some scenarios"),", you'll setup two or more NICs in your VM to serve different networking purposes. If all networks are setup by default with DHCP, you might get random connectivity issues. And while it might get fixed after rebooting the VM, it still will lose connection randomly after some period."),(0,o.kt)("h2",{id:"how-to-identify-connectivity-issues"},"How-to identify connectivity issues"),(0,o.kt)("p",null,"In a Linux VM, you can use commands from the ",(0,o.kt)("inlineCode",{parentName:"p"},"iproute2")," package to identify the default route."),(0,o.kt)("p",null,"In your VM, execute the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ip route show default\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you get the ",(0,o.kt)("inlineCode",{parentName:"p"},"access denied")," error, please run the command using ",(0,o.kt)("inlineCode",{parentName:"p"},"sudo"))),(0,o.kt)("p",null,"The output of this command will only show the default route with the gateway and VM IP of the primary network interface (",(0,o.kt)("inlineCode",{parentName:"p"},"eth0")," in the example below)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"default via <Gateway IP> dev eth0 proto dhcp src <VM IP> metric 100\n")),(0,o.kt)("p",null,"Here is the full example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ ip route show default\ndefault via 192.168.0.254 dev eth0 proto dhcp src 192.168.0.100 metric 100\n")),(0,o.kt)("p",null,"However, if the issue covered in this KB occurs, you'll only be able to connect to the VM via the VNC or serial console."),(0,o.kt)("p",null,"Once connected, you can run again the same command as before:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ ip route show default\n")),(0,o.kt)("p",null,"However, this time you'll get a default route with an incorrect gateway IP.\nFor example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"default via <Incorrect Gateway IP> dev eth0 proto dhcp src <VM's IP> metric 100\n")),(0,o.kt)("h2",{id:"why-do-connectivity-issues-occur-randomly"},"Why do connectivity issues occur randomly"),(0,o.kt)("p",null,"In a standard setup, cloud-based VMs typically use DHCP for their NICs configuration. It will set an IP and a gateway for each NIC. Lastly, a default route to the gateway IP will also be added, so you can use its IP to connect to the VM."),(0,o.kt)("p",null,"However, Linux distributions start multiple DHCP clients at the same time and do not have a ",(0,o.kt)("strong",{parentName:"p"},"priority")," system. This means that if you have two or more NICs configured with DHCP, the client will enter a ",(0,o.kt)("strong",{parentName:"p"},"race condition")," to configure the default route. And depending on the currently running Linux distribution DHCP script, there is no guarantee which default route will be configured."),(0,o.kt)("p",null,"As the default route might change in every DHCP renewing process or after every OS reboot, this will create network connectivity issues."),(0,o.kt)("h2",{id:"how-to-avoid-the-random-connectivity-issues"},"How to avoid the random connectivity issues"),(0,o.kt)("p",null,"You can easily avoid these connectivity issues by having only one NIC attached to the VM and having only one IP and one gateway configured."),(0,o.kt)("p",null,"However, for VMs in more complex infrastructures, it is often not possible to use just one NIC. For example, if your infrastructure has a storage network and a service network. For security reasons, the storage network will be isolated from the service network and have a separate subnet. In this case, you must have two NICs to connect to both the service and storage networks."),(0,o.kt)("p",null,"You can choose a solution below that meets your requirements and security policy."),(0,o.kt)("h3",{id:"disable-dhcp-on-secondary-nic"},"Disable DHCP on secondary NIC"),(0,o.kt)("p",null,"As mentioned above, the problem is caused by a ",(0,o.kt)("inlineCode",{parentName:"p"},"race condition")," between two DHCP clients. One solution to avoid this problem is to disable DHCP for all NICs and configure them with static IPs only. Likewise, you can configure the secondary NIC with a static IP and keep the primary NIC enabled with DHCP."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"To configure the primary NIC with a static IP (",(0,o.kt)("inlineCode",{parentName:"li"},"eth0")," in this example), you can edit the file ",(0,o.kt)("inlineCode",{parentName:"li"},"/etc/sysconfig/network/ifcfg-eth0")," with the following values:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"BOOTPROTO='static'\nIPADDR='192.168.0.100'\nNETMASK='255.255.255.0'\n")),(0,o.kt)("p",null,"Alternatively, if you want to reserve the primary NIC using DHCP (",(0,o.kt)("inlineCode",{parentName:"p"},"eth0")," in this example), use the following values instead:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"BOOTPROTO='dhcp'\nDHCLIENT_SET_DEFAULT_ROUTE='yes'\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"You need to configure the default route by editing the file ",(0,o.kt)("inlineCode",{parentName:"li"},"/etc/sysconfig/network/ifroute-eth0")," (if you configured the primary NIC using DHCP, skip this step):")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"# Destination  Dummy/Gateway  Netmask  Interface\ndefault        192.168.0.254  -        eth0\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Do not put other default route for your secondary NIC")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Finally, configure a static IP for the secondary NIC by editing the file ",(0,o.kt)("inlineCode",{parentName:"li"},"/etc/sysconfig/network/ifcfg-eth1"),":")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"BOOTPROTO='static'\nIPADDR='10.0.0.100'\nNETMASK='255.255.255.0'\n")),(0,o.kt)("h4",{id:"cloud-init-config"},"Cloud-Init config"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"network:\n  version: 1\n  config:\n    - type: physical\n      name: eth0\n      subnets:\n        - type: dhcp\n    - type: physical\n      name: eth1\n      subnets:\n        - type: static\n          address: 10.0.0.100/24\n")),(0,o.kt)("h3",{id:"disable-secondary-nic-default-route-from-dhcp"},"Disable secondary NIC default route from DHCP"),(0,o.kt)("p",null,"If your secondary NIC requires to get its IP from DHCP, you'll need to disable the secondary NIC default route configuration."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Confirm that the primary NIC configures its default route in the file ",(0,o.kt)("inlineCode",{parentName:"li"},"/etc/sysconfig/network/ifcfg-eth0"),":")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"BOOTPROTO='dhcp'\nDHCLIENT_SET_DEFAULT_ROUTE='yes'\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Disable the secondary NIC default route configuration by editing the file ",(0,o.kt)("inlineCode",{parentName:"li"},"/etc/sysconfig/network/ifcfg-eth1"),":")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"BOOTPROTO='dhcp'\nDHCLIENT_SET_DEFAULT_ROUTE='no'\n")),(0,o.kt)("h4",{id:"cloud-init-config-1"},"Cloud-Init config"),(0,o.kt)("p",null,"This solution is not available in Cloud-Init. Cloud-Init didn't allow any option for DHCP."))}d.isMDXComponent=!0}}]);